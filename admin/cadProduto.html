<!DOCTYPE html>
<html lang="pt-br">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Gerenciador de Produtos Otimizado</title>
		<script src="https://cdn.tailwindcss.com"></script>
		<style>
			@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

			body {
				font-family: 'Inter', sans-serif;
			}

			.log-item {
				padding: 8px 12px;
				border-radius: 6px;
				margin-bottom: 8px;
				font-size: 0.875rem;
				animation: fadeIn 0.3s ease-in-out;
			}

			.log-success {
				background-color: #dcfce7;
				color: #166534;
				border-left: 4px solid #22c55e;
			}

			.log-error {
				background-color: #fee2e2;
				color: #991b1b;
				border-left: 4px solid #ef4444;
			}

			.log-info {
				background-color: #e0f2fe;
				color: #0369a1;
				border-left: 4px solid #0ea5e9;
			}

			.log-warning {
				background-color: #fef9c3;
				color: #854d0e;
				border-left: 4px solid #eab308;
			}

			/* Estilos para abas */
			.tab-button {
				border-bottom-width: 2px;
				border-color: transparent;
			}
			.tab-button.active {
				border-color: #4f46e5;
				color: #4f46e5;
				background-color: #eef2ff;
			}
			.tab-content {
				display: none;
			}
			.tab-content.active {
				display: block;
			}

			@keyframes fadeIn {
				from {
					opacity: 0;
					transform: translateY(-10px);
				}
				to {
					opacity: 1;
					transform: translateY(0);
				}
			}
		</style>
	</head>

	<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
		<div class="w-full max-w-6xl mx-auto bg-white p-8 rounded-xl shadow-lg">
			<header class="mb-6 text-center">
				<h1 class="text-3xl font-bold text-gray-800">
					Gerenciador de Produtos & Categorias
				</h1>
				<p class="text-gray-500 mt-1">
					Ferramenta completa para gerenciar (CRUD) via API.
				</p>
			</header>

			<!-- Abas de Navega√ß√£o -->
			<div class="mb-6 border-b border-gray-200">
				<nav
					class="-mb-px flex space-x-6 overflow-x-auto"
					aria-label="Tabs"
				>
					<button
						onclick="changeTab('tab-categories')"
						class="tab-button active whitespace-nowrap py-4 px-1 font-medium text-sm text-gray-500 hover:text-indigo-600 hover:border-indigo-300"
					>
						Gerenciar Categorias
					</button>
					<button
						onclick="changeTab('tab-create')"
						class="tab-button whitespace-nowrap py-4 px-1 font-medium text-sm text-gray-500 hover:text-indigo-600 hover:border-indigo-300"
					>
						Cadastrar Produtos (Massa)
					</button>
					<button
						onclick="changeTab('tab-update')"
						class="tab-button whitespace-nowrap py-4 px-1 font-medium text-sm text-gray-500 hover:text-indigo-600 hover:border-indigo-300"
					>
						Corrigir Produtos (Massa)
					</button>
					<button
						onclick="changeTab('tab-list')"
						class="tab-button whitespace-nowrap py-4 px-1 font-medium text-sm text-gray-500 hover:text-indigo-600 hover:border-indigo-300"
					>
						Listar / Editar
					</button>
					<button
						onclick="changeTab('tab-search')"
						class="tab-button whitespace-nowrap py-4 px-1 font-medium text-sm text-gray-500 hover:text-indigo-600 hover:border-indigo-300"
					>
						Buscar
					</button>
				</nav>
			</div>

			<main>
				<!-- Conte√∫do da Aba: Gerenciar Categorias -->
				<div id="tab-categories" class="tab-content active">
					<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
						
						<!-- Coluna da Esquerda: Cadastro Individual e Massa -->
						<div class="space-y-6">
							<!-- Adicionar Nova Categoria (Individual) -->
							<div class="bg-gray-50 p-6 rounded-lg border">
								<h3 class="text-lg font-semibold text-gray-800 mb-4">
									Adicionar Nova Categoria (Individual)
								</h3>
								<form id="add-category-form" class="space-y-4">
									<div>
										<label for="new-group-code" class="block text-sm font-medium text-gray-700 mb-1">C√≥digo da Categoria</label>
										<input type="text" id="new-group-code" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="Ex: SALGADOS" />
									</div>
									<div>
										<label for="new-group-name" class="block text-sm font-medium text-gray-700 mb-1">Nome da Categoria</label>
										<input type="text" id="new-group-name" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="Ex: Salgados" />
									</div>
									<button type="submit" class="w-full px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700">
										Adicionar Categoria
									</button>
								</form>
							</div>

							<!-- Cadastrar Categorias em Massa (NOVO) -->
							<div class="bg-indigo-50 p-6 rounded-lg border border-indigo-100">
								<h3 class="text-lg font-semibold text-indigo-900 mb-2">
									Cadastrar Categorias em Massa
								</h3>
								<p class="text-xs text-indigo-600 mb-2">Cole o JSON das categorias aqui.</p>
								<textarea
									id="json-input-categories"
									rows="5"
									class="w-full p-3 border border-indigo-200 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 text-sm mb-3"
									placeholder='[{"group_code": "BEBIDAS", "name": "Bebidas", "image_url": "..."}]'
								></textarea>
								<button
									id="start-categories-mass-button"
									class="w-full px-4 py-2 bg-indigo-700 text-white font-semibold rounded-lg hover:bg-indigo-800 transition"
								>
									Processar Lote de Categorias
								</button>
							</div>
						</div>

						<!-- Lista de Categorias -->
						<div class="bg-gray-50 p-6 rounded-lg border flex flex-col h-full">
							<div class="flex justify-between items-center mb-4">
								<h3 class="text-lg font-semibold text-gray-800">
									Categorias Cadastradas
								</h3>
								<button
									id="refresh-categories-button"
									class="px-3 py-1 bg-blue-600 text-white text-sm font-semibold rounded hover:bg-blue-700"
								>
									üîÑ Atualizar Lista
								</button>
							</div>
							<div
								id="categories-list"
								class="space-y-2 flex-grow overflow-y-auto max-h-[500px]"
							>
								<div class="text-center text-gray-500 py-4">
									Carregue as categorias para visualizar
								</div>
							</div>
						</div>
					</div>
				</div>

				<!-- Conte√∫do da Aba: Cadastrar Produtos em Massa -->
				<div id="tab-create" class="tab-content">
					<div class="bg-green-50 border-l-4 border-green-500 p-4 mb-4">
						<p class="text-sm text-green-700 font-bold">Use esta aba para CADASTRAR NOVOS produtos (que ainda n√£o t√™m ID).</p>
					</div>
					<div class="mb-6">
						<label
							for="json-input"
							class="block text-sm font-medium text-gray-700 mb-2"
							>Cole aqui o JSON da lista de produtos para CADASTRAR:</label
						>
						<textarea
							id="json-input"
							rows="10"
							class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-green-500 focus:border-green-500 transition"
							placeholder="Cole o array de produtos aqui..."
						></textarea>
					</div>
					<div class="flex justify-center mb-6">
						<button
							id="start-button"
							class="w-full md:w-auto px-8 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition disabled:bg-gray-400 disabled:cursor-not-allowed"
						>
							Iniciar Cadastro de Produtos
						</button>
					</div>
				</div>

				<!-- Conte√∫do da Aba: Corrigir em Massa -->
				<div id="tab-update" class="tab-content">
					<div class="bg-purple-50 border-l-4 border-purple-500 p-4 mb-4">
						<p class="text-sm text-purple-700 font-bold">Use esta aba APENAS para ATUALIZAR produtos que j√° existem (obrigat√≥rio ter "id").</p>
					</div>
					<div class="mb-6">
						<label
							for="json-input-update"
							class="block text-sm font-medium text-gray-700 mb-2"
						>
							Cole aqui o JSON da lista de produtos para ATUALIZAR:
						</label>
						<textarea
							id="json-input-update"
							rows="10"
							class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition"
							placeholder='[{"id": 123, "name": "Nome Novo", ...}]'
						></textarea>
					</div>
					<div class="flex justify-center mb-6">
						<button
							id="start-update-button"
							class="w-full md:w-auto px-8 py-3 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition disabled:bg-gray-400 disabled:cursor-not-allowed"
						>
							Iniciar Corre√ß√£o em Massa
						</button>
					</div>
				</div>

				<!-- Conte√∫do da Aba: Listar Produtos -->
				<div id="tab-list" class="tab-content">
					<button
						id="fetch-products-button"
						class="mb-4 px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700"
					>
						Carregar Todos os Produtos
					</button>
					<div id="product-list" class="space-y-2"></div>
				</div>

				<!-- Conte√∫do da Aba: Buscar Produto -->
				<div id="tab-search" class="tab-content">
					<div class="flex space-x-4 mb-4">
						<input
							type="text"
							id="search-input"
							class="flex-grow p-2 border rounded-lg"
							placeholder="Digite o nome ou ID do produto"
						/>
						<button
							id="search-button"
							class="px-6 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700"
						>
							Buscar
						</button>
					</div>
					<div id="search-results"></div>
				</div>

				<!-- Modal de Edi√ß√£o de Categoria -->
				<div
					id="edit-category-modal"
					class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50"
				>
					<div
						class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white"
					>
						<h3
							class="text-xl font-medium leading-6 text-gray-900 mb-4"
						>
							Editar Categoria
						</h3>
						<form id="edit-category-form">
							<input type="hidden" id="edit-category-id" />
							<div class="space-y-4">
								<div>
									<label
										for="edit-category-code"
										class="block text-sm font-medium text-gray-700"
										>C√≥digo da Categoria</label
									>
									<input
										type="text"
										id="edit-category-code"
										required
										class="mt-1 p-2 w-full border rounded-md"
									/>
								</div>
								<div>
									<label
										for="edit-category-name"
										class="block text-sm font-medium text-gray-700"
										>Nome da Categoria</label
									>
									<input
										type="text"
										id="edit-category-name"
										required
										class="mt-1 p-2 w-full border rounded-md"
									/>
								</div>
							</div>
							<div class="mt-6 flex justify-end space-x-3">
								<button
									type="button"
									onclick="closeCategoryModal()"
									class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 font-medium"
								>
									Cancelar
								</button>
								<button
									type="submit"
									class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 font-semibold"
								>
									Salvar Altera√ß√µes
								</button>
							</div>
						</form>
					</div>
				</div>

				<!-- Modal de Edi√ß√£o de Produto (escondido por padr√£o) -->
				<div
					id="edit-modal"
					class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50"
				>
					<div
						class="relative top-10 mx-auto p-5 border w-full max-w-3xl shadow-lg rounded-md bg-white"
					>
						<h3
							class="text-xl font-medium leading-6 text-gray-900 mb-4"
						>
							Editar Produto
						</h3>
						<form id="edit-form">
							<input type="hidden" id="edit-product-id" />
							<div
								class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4"
							>
								<div class="md:col-span-2">
									<label
										for="edit-name"
										class="block text-sm font-medium text-gray-700"
										>Nome</label
									><input
										type="text"
										id="edit-name"
										class="mt-1 p-2 w-full border rounded-md"
									/>
								</div>
								<div>
									<label
										for="edit-product_code"
										class="block text-sm font-medium text-gray-700"
										>C√≥digo do Produto</label
									><input
										type="text"
										id="edit-product_code"
										class="mt-1 p-2 w-full border rounded-md"
									/>
								</div>
								<div>
									<label
										for="edit-group_code"
										class="block text-sm font-medium text-gray-700"
										>C√≥digo do Grupo</label
									><input
										type="text"
										id="edit-group_code"
										class="mt-1 p-2 w-full border rounded-md"
									/>
								</div>
								<div>
									<label
										for="edit-price"
										class="block text-sm font-medium text-gray-700"
										>Pre√ßo</label
									><input
										type="number"
										step="0.01"
										id="edit-price"
										class="mt-1 p-2 w-full border rounded-md"
									/>
								</div>
								<div>
									<label
										for="edit-ean_code"
										class="block text-sm font-medium text-gray-700"
										>EAN</label
									><input
										type="text"
										id="edit-ean_code"
										class="mt-1 p-2 w-full border rounded-md"
									/>
								</div>

								<div class="md:col-span-2">
									<label
										for="edit-description"
										class="block text-sm font-medium text-gray-700"
										>Descri√ß√£o</label
									><textarea
										id="edit-description"
										rows="3"
										class="mt-1 p-2 w-full border rounded-md"
									></textarea>
								</div>

								<div
									class="md:col-span-2 p-4 border border-gray-200 rounded-lg bg-gray-50"
								>
									<label
										for="edit-image_url"
										class="block text-sm font-medium text-gray-700 mb-2"
										>URL da Imagem</label
									>
									<div
										class="flex flex-col sm:flex-row items-start gap-4"
									>
										<input
											type="text"
											id="edit-image_url"
											placeholder="https://exemplo.com/imagem.png"
											class="flex-grow p-2 border border-gray-300 rounded-md w-full"
										/>
										<img
											id="edit-image-preview"
											src="https://placehold.co/128x128/e2e8f0/cbd5e1?text=Preview"
											onerror="this.onerror=null;this.src='https://placehold.co/128x128/fecaca/991b1b?text=Inv√°lida';"
											alt="Preview da Imagem"
											class="w-32 h-32 object-cover rounded-md bg-gray-200 border flex-shrink-0"
										/>
									</div>
								</div>
							</div>
							<div class="mt-6 flex justify-end space-x-3">
								<button
									type="button"
									onclick="closeModal()"
									class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 font-medium"
								>
									Cancelar
								</button>
								<button
									type="submit"
									class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 font-semibold"
								>
									Salvar Altera√ß√µes
								</button>
							</div>
						</form>
					</div>
				</div>

				<!-- Logs Unificados -->
				<div id="status-container" class="mt-6">
					<h2 class="text-lg font-semibold text-gray-700 mb-2">
						Log de Opera√ß√µes:
					</h2>
					<div
						id="logs"
						class="w-full h-64 bg-gray-900 text-gray-100 p-4 border border-gray-700 rounded-lg overflow-y-auto font-mono text-sm shadow-inner"
					>
						> Aguardando comandos...
					</div>
				</div>
			</main>
		</div>

		<script>
			// --- CONFIGURA√á√ïES ---
			const authToken =
				'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOjEyLCJ1c2VybmFtZSI6IlBlZHJvIiwiY3BmQ25waiI6IiIsImVtYWlsIjoicGVkcm9AYml4cy5jb20uYnIiLCJpc0FkbWluIjp0cnVlLCJzdWIiOiIxMiIsImV4cCI6MTc2NDA4MDMzMywiaWF0IjoxNzYzOTkzOTMzfQ.MQBt1LQYA7JBejZAjVtX51s2YYH0uz37WJGiODYujwE';
			const apiUrlBase = 'https://dev.bixs.com.br/v1/api/products';
			const apiGroupsUrl = 'https://dev.bixs.com.br/v1/api/groups';
			const sourceName = 'uai_pdv_mais';
			const sourceQuery = `?source=${sourceName}`;
			const placeholderImgUrl =
				'https://placehold.co/64x64/e2e8f0/cbd5e1?text=Sem+Foto';
			const errorImgUrl =
				'https://placehold.co/64x64/fecaca/991b1b?text=Erro';
			const previewPlaceholderUrl =
				'https://placehold.co/128x128/e2e8f0/cbd5e1?text=Preview';

			// --- ELEMENTOS DO DOM ---
			const logsContainer = document.getElementById('logs');
			const startButton = document.getElementById('start-button');
			const jsonInput = document.getElementById('json-input');
			const startUpdateButton = document.getElementById(
				'start-update-button'
			);
			const jsonInputUpdate =
				document.getElementById('json-input-update');
			const fetchProductsButton = document.getElementById(
				'fetch-products-button'
			);
			const productListContainer =
				document.getElementById('product-list');
			const searchInput = document.getElementById('search-input');
			const searchButton = document.getElementById('search-button');
			const searchResultsContainer =
				document.getElementById('search-results');
			const modal = document.getElementById('edit-modal');
			const editForm = document.getElementById('edit-form');
			const imageUrlInput = document.getElementById('edit-image_url');
			const imagePreview = document.getElementById('edit-image-preview');

			// Elementos de Categoria
			const addCategoryForm =
				document.getElementById('add-category-form');
			const refreshCategoriesButton = document.getElementById(
				'refresh-categories-button'
			);
			const categoriesListContainer =
				document.getElementById('categories-list');
			const categoryModal = document.getElementById(
				'edit-category-modal'
			);
			const editCategoryForm =
				document.getElementById('edit-category-form');
			
			// Novos Elementos para Categorias em Massa
			const startCategoriesMassButton = document.getElementById('start-categories-mass-button');
			const jsonInputCategories = document.getElementById('json-input-categories');

			// --- FUN√á√ïES DE LOG E UTILIDADES ---
			function logMessage(message, type = 'info') {
				if (logsContainer.innerHTML.includes('> Aguardando comandos...')) {
					logsContainer.innerHTML = '';
				}
				const logItem = document.createElement('div');
				logItem.textContent = `> ${message}`; 
				const typeClasses = {
					info: 'text-blue-300',
					success: 'text-green-400 font-bold',
					error: 'text-red-400 font-bold',
					warning: 'text-yellow-300'
				};
				// Aplicar classes do tailwind baseadas no tipo
				if (typeClasses[type]) {
					logItem.className = `mb-1 ${typeClasses[type]}`;
				} else {
					logItem.className = "mb-1 text-gray-300";
				}
				
				logsContainer.appendChild(logItem);
				logsContainer.scrollTop = logsContainer.scrollHeight;
			}

			function clearLogs() {
				logsContainer.innerHTML = '> Aguardando comandos...';
			}

			// --- L√ìGICA DAS ABAS ---
			function changeTab(tabId) {
				document
					.querySelectorAll('.tab-content')
					.forEach((tab) => tab.classList.remove('active'));
				document
					.querySelectorAll('.tab-button')
					.forEach((button) => button.classList.remove('active'));
				document.getElementById(tabId).classList.add('active');
				event.currentTarget.classList.add('active');
				// N√£o limpa logs automaticamente para n√£o perder hist√≥rico de processos longos
			}

			// --- FUN√á√ÉO DE TRANSFORMA√á√ÉO DE DADOS ---
			function transformProductForApi(product) {
				return {
					description: product.description || '',
					ean_code: product.ean_code || '',
					group_code:
						product.group_code || product.group?.group_code || '',
					image_url: product.image_url || '',
					name: product.name || '',
					price: parseFloat(product.base_price || product.price || 0),
					product_code: product.product_code || '',
					source_name: product.source_name || sourceName,
				};
			}

			// --- FUN√á√ïES DA API (GERAIS E CRUD) ---
			async function processMassAction(produtos, method) {
				const button =
					method === 'POST' ? startButton : startUpdateButton;
				button.disabled = true;
				button.textContent = "Processando...";
				const actionName =
					method === 'POST' ? 'CADASTRO' : 'ATUALIZA√á√ÉO';
				logMessage(
					`=== INICIANDO ${actionName} EM MASSA DE ${produtos.length} PRODUTOS ===`, 'info'
				);

				let successCount = 0;
				let errorCount = 0;

				for (let i = 0; i < produtos.length; i++) {
					const produtoOriginal = produtos[i];
					const payload = transformProductForApi(produtoOriginal);
					const produtoIdentifier =
						payload.name || `ID ${produtoOriginal.id}`;
					
					// Verifica erro comum: tentar atualizar sem ID
					if (method === 'PUT' && !produtoOriginal.id) {
						logMessage(`[${i + 1}/${produtos.length}] PULADO: "${produtoIdentifier}" n√£o tem ID. Para cadastrar novos, use a aba "Cadastrar".`, 'warning');
						errorCount++;
						continue;
					}

					logMessage(
						`[${i + 1}/${produtos.length}] Processando: ${produtoIdentifier}...`
					);

					try {
						let url;
						if (method === 'PUT') {
							url = `${apiUrlBase}/${produtoOriginal.id}${sourceQuery}`;
						} else {
							url = `${apiUrlBase}${sourceQuery}`;
						}

						const response = await fetch(url, {
							method: method,
							headers: {
								'Content-Type': 'application/json',
								Authorization: `Bearer ${authToken}`,
							},
							body: JSON.stringify(payload),
						});

						if (!response.ok) {
							const errorData = await response
								.json()
								.catch(() => ({}));
							const errorMessage =
								errorData.details ||
								errorData.message ||
								`Erro HTTP ${response.status}`;
							throw new Error(errorMessage);
						}

						logMessage(
							`[${i + 1}/${produtos.length}] SUCESSO: "${produtoIdentifier}" OK.`,
							'success'
						);
						successCount++;
					} catch (error) {
						logMessage(
							`[${i + 1}/${produtos.length}] ERRO em "${produtoIdentifier}": ${error.message}`,
							'error'
						);
						errorCount++;
					}
					// Pequeno delay para n√£o sobrecarregar
					await new Promise((resolve) => setTimeout(resolve, 200));
				}
				logMessage(`=== FINALIZADO: ${successCount} Sucessos | ${errorCount} Falhas ===`, successCount > 0 ? 'success' : 'error');
				button.disabled = false;
				button.textContent = method === 'POST' ? "Iniciar Cadastro de Produtos" : "Iniciar Corre√ß√£o em Massa";
			}

			async function handleCadastro() {
				clearLogs();
				try {
					const produtos = JSON.parse(jsonInput.value);
					if (!Array.isArray(produtos))
						throw new Error('O JSON n√£o √© uma lista (array).');
					await processMassAction(produtos, 'POST');
				} catch (error) {
					logMessage(
						`Erro ao processar o JSON: ${error.message}`,
						'error'
					);
				}
			}

			async function handleUpdateMass() {
				clearLogs();
				try {
					const produtos = JSON.parse(jsonInputUpdate.value);
					if (!Array.isArray(produtos))
						throw new Error('O JSON n√£o √© uma lista (array).');
					await processMassAction(produtos, 'PUT');
				} catch (error) {
					logMessage(
						`Erro ao processar o JSON: ${error.message}`,
						'error'
					);
				}
			}

			async function fetchAllProducts() {
				logMessage('Buscando produtos na API...');
				productListContainer.innerHTML =
					'<div class="text-center p-4">Carregando...</div>';
				try {
					const response = await fetch(
						`${apiUrlBase}${sourceQuery}`,
						{
							headers: { Authorization: `Bearer ${authToken}` },
						}
					);
					if (!response.ok)
						throw new Error(`Erro ${response.status}`);
					const products = await response.json();
					renderProductList(products);
					logMessage(
						`${products.length} produtos carregados com sucesso.`,
						'success'
					);
				} catch (error) {
					logMessage(
						`Falha ao buscar produtos: ${error.message}`,
						'error'
					);
					productListContainer.innerHTML =
						'<div class="text-center p-4 text-red-600">Falha ao carregar.</div>';
				}
			}

			async function handleUpdateProduct(event) {
				event.preventDefault();
				const id = document.getElementById('edit-product-id').value;
				const payload = {
					description:
						document.getElementById('edit-description').value,
					ean_code: document.getElementById('edit-ean_code').value,
					group_code:
						document.getElementById('edit-group_code').value,
					image_url: document.getElementById('edit-image_url').value,
					name: document.getElementById('edit-name').value,
					price: parseFloat(
						document.getElementById('edit-price').value
					),
					product_code:
						document.getElementById('edit-product_code').value,
				};

				logMessage(`Atualizando produto ID: ${id}...`);
				try {
					const response = await fetch(
						`${apiUrlBase}/${id}${sourceQuery}`,
						{
							method: 'PUT',
							headers: {
								'Content-Type': 'application/json',
								Authorization: `Bearer ${authToken}`,
							},
							body: JSON.stringify(payload),
						}
					);
					if (!response.ok) {
						const errorData = await response
							.json()
							.catch(() => ({}));
						const errorMessage =
							errorData.details ||
							errorData.message ||
							`Erro HTTP ${response.status}`;
						throw new Error(errorMessage);
					}
					logMessage(
						`Produto "${payload.name}" atualizado com sucesso!`,
						'success'
					);
					closeModal();
					if (
						document
							.getElementById('tab-list')
							.classList.contains('active')
					) {
						fetchAllProducts();
					} else if (
						document
							.getElementById('tab-search')
							.classList.contains('active')
					) {
						handleSearch();
					}
				} catch (error) {
					logMessage(`Erro ao atualizar: ${error.message}`, 'error');
				}
			}

			async function deleteProduct(id, name) {
				if (
					!(await showConfirm(
						`Tem certeza que deseja excluir o produto "${name}" (ID: ${id})?`
					))
				)
					return;
				logMessage(`Excluindo produto ID: ${id}...`);
				try {
					const response = await fetch(
						`${apiUrlBase}/${id}${sourceQuery}`,
						{
							method: 'DELETE',
							headers: { Authorization: `Bearer ${authToken}` },
						}
					);
					if (!response.ok) {
						const errorData = await response
							.json()
							.catch(() => ({}));
						const errorMessage =
							errorData.details ||
							errorData.message ||
							`Erro HTTP ${response.status}`;
						throw new Error(errorMessage);
					}
					logMessage(
						`Produto "${name}" exclu√≠do com sucesso.`,
						'success'
					);
					if (
						document
							.getElementById('tab-list')
							.classList.contains('active')
					) {
						fetchAllProducts();
					} else if (
						document
							.getElementById('tab-search')
							.classList.contains('active')
					) {
						handleSearch();
					}
				} catch (error) {
					logMessage(
						`Falha ao excluir produto: ${error.message}`,
						'error'
					);
				}
			}

			async function handleSearch() {
				const query = searchInput.value.trim();
				if (!query) return;
				// clearLogs();
				logMessage(`Buscando por "${query}"...`);
				searchResultsContainer.innerHTML = 'Carregando...';
				const isIdSearch = /^\d+$/.test(query);
				const searchUrl = isIdSearch
					? `${apiUrlBase}/${query}${sourceQuery}`
					: `${apiUrlBase}/search${sourceQuery}&name=${encodeURIComponent(
							query
					  )}`;
				try {
					const response = await fetch(searchUrl, {
						headers: { Authorization: `Bearer ${authToken}` },
					});
					if (response.status === 404) {
						searchResultsContainer.innerHTML =
							'<div class="text-center p-4">Nenhum produto encontrado.</div>';
						logMessage(`Nenhum resultado para "${query}".`, 'info');
						return;
					}
					if (!response.ok)
						throw new Error(`Erro na API: ${response.statusText}`);
					let results = await response.json();
					if (!Array.isArray(results)) results = [results];
					renderProductList(results, searchResultsContainer);
					logMessage(
						`Busca por "${query}" retornou ${results.length} resultado(s).`,
						'success'
					);
				} catch (error) {
					logMessage(`Erro na busca: ${error.message}`, 'error');
					searchResultsContainer.innerHTML = `<div class="text-red-600 p-4">Falha na busca. Detalhes: ${error.message}</div>`;
				}
			}

			function renderProductList(
				products,
				container = productListContainer
			) {
				container.innerHTML = '';
				if (!products || products.length === 0) {
					container.innerHTML =
						'<div class="text-center p-4">Nenhum produto encontrado.</div>';
					return;
				}
				products.forEach((product) => {
					const productDiv = document.createElement('div');
					productDiv.className =
						'p-3 bg-white border rounded-lg flex items-center justify-between gap-4 flex-wrap sm:flex-nowrap hover:bg-gray-50 transition';
					productDiv.innerHTML = `
						<div class="flex items-center space-x-4 flex-grow min-w-0">
							<img src="${product.image_url || placeholderImgUrl}"
								 onerror="this.onerror=null;this.src='${errorImgUrl}';"
								 alt="Imagem de ${
										product.name
									}" class="w-16 h-16 object-cover rounded-md bg-gray-200 flex-shrink-0">
							<div class="min-w-0">
								<p class="font-bold text-gray-800 truncate" title="${product.name}">${
						product.name
					}</p>
								<p class="text-xs text-gray-500">ID: ${product.id} | C√≥digo: ${
						product.product_code || 'N/A'
					} | Grupo: ${product.group?.group_code || 'N/A'}</p>
								<p class="text-sm text-blue-600 font-semibold">R$ ${(
									product.base_price || 0
								).toFixed(2)}</p>
							</div>
						</div>
						<div class="space-x-2 flex-shrink-0">
							<button onclick='openModal(${JSON.stringify(
								product
							)})' class="px-3 py-1 bg-yellow-500 text-white text-xs font-semibold rounded hover:bg-yellow-600">Editar</button>
							<button onclick='deleteProduct(${JSON.stringify(product.id)}, ${JSON.stringify(
						product.name
					)})' class="px-3 py-1 bg-red-600 text-white text-xs font-semibold rounded hover:bg-red-700">Excluir</button>
						</div>
					`;
					container.appendChild(productDiv);
				});
			}

			function openModal(product) {
				document.getElementById('edit-product-id').value = product.id;
				document.getElementById('edit-name').value = product.name || '';
				document.getElementById('edit-product_code').value =
					product.product_code || '';
				document.getElementById('edit-group_code').value =
					product.group?.group_code || product.group_code || '';
				document.getElementById('edit-price').value =
					product.base_price || 0;
				document.getElementById('edit-ean_code').value =
					product.ean_code || '';
				document.getElementById('edit-description').value =
					product.description || '';
				const imageUrl = product.image_url || '';
				imageUrlInput.value = imageUrl;
				imagePreview.src = imageUrl || previewPlaceholderUrl;
				modal.classList.remove('hidden');
			}

			function closeModal() {
				modal.classList.add('hidden');
			}

			function showConfirm(message) {
				return new Promise((resolve) => {
					const existingModal =
						document.getElementById('confirm-modal');
					if (existingModal) existingModal.remove();
					const confirmModal = document.createElement('div');
					confirmModal.id = 'confirm-modal';
					confirmModal.className =
						'fixed inset-0 bg-gray-800 bg-opacity-60 flex items-center justify-center z-50';
					confirmModal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm mx-4">
                        <p class="text-lg text-gray-800 mb-4">${message}</p>
                        <div class="flex justify-end space-x-3">
                            <button id="confirm-cancel" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Cancelar</button>
                            <button id="confirm-ok" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Confirmar</button>
                        </div>
                    </div>
                `;
					document.body.appendChild(confirmModal);
					document.getElementById('confirm-ok').onclick = () => {
						confirmModal.remove();
						resolve(true);
					};
					document.getElementById('confirm-cancel').onclick = () => {
						confirmModal.remove();
						resolve(false);
					};
				});
			}

			// --- FUN√á√ïES DE GERENCIAMENTO DE CATEGORIAS ---
			async function fetchAllCategories() {
				// logMessage('Buscando categorias na API...');
				categoriesListContainer.innerHTML =
					'<div class="text-center p-4">Carregando...</div>';
				try {
					const response = await fetch(
						`${apiGroupsUrl}${sourceQuery}`,
						{
							headers: { Authorization: `Bearer ${authToken}` },
						}
					);
					if (!response.ok)
						throw new Error(`Erro ${response.status}`);
					const categories = await response.json();
					renderCategoriesList(categories);
					// logMessage(`${categories.length} categorias carregadas.`, 'info');
				} catch (error) {
					logMessage(
						`Falha ao buscar categorias: ${error.message}`,
						'error'
					);
					categoriesListContainer.innerHTML =
						'<div class="text-center p-4 text-red-600">Falha ao carregar.</div>';
				}
			}

			async function handleMassCategories() {
				const button = startCategoriesMassButton;
				button.disabled = true;
				button.textContent = "Processando...";
				
				try {
					const categorias = JSON.parse(jsonInputCategories.value);
					if (!Array.isArray(categorias)) throw new Error("O JSON precisa ser uma lista []");

					logMessage(`=== INICIANDO CADASTRO DE ${categorias.length} CATEGORIAS ===`, 'info');
					
					let successCount = 0;
					
					for(let i=0; i<categorias.length; i++) {
						const cat = categorias[i];
						const payload = {
							group_code: cat.group_code,
							name: cat.name
						};
						
						logMessage(`[${i+1}/${categorias.length}] Cadastrando: ${cat.name}...`);
						
						try {
							const response = await fetch(`${apiGroupsUrl}${sourceQuery}`, {
								method: 'POST',
								headers: {
									'Content-Type': 'application/json',
									Authorization: `Bearer ${authToken}`,
								},
								body: JSON.stringify(payload),
							});
							
							if(!response.ok) throw new Error(`Erro API ${response.status}`);
							logMessage(`‚úÖ ${cat.name} cadastrada!`, 'success');
							successCount++;
						} catch(err) {
							logMessage(`‚ùå Erro em ${cat.name}: ${err.message}`, 'error');
						}
						await new Promise(r => setTimeout(r, 100));
					}
					
					logMessage(`Fim do processamento. ${successCount} criadas.`, 'success');
					fetchAllCategories(); // Atualiza a lista visual
					
				} catch (error) {
					logMessage(`Erro no JSON: ${error.message}`, 'error');
				}
				button.disabled = false;
				button.textContent = "Processar Lote de Categorias";
			}

			async function handleAddCategory(event) {
				event.preventDefault();
				const payload = {
					group_code: document
						.getElementById('new-group-code')
						.value.trim(),
					name: document
						.getElementById('new-group-name')
						.value.trim(),
				};

				logMessage(`Cadastrando categoria "${payload.name}"...`);
				try {
					const response = await fetch(
						`${apiGroupsUrl}${sourceQuery}`,
						{
							method: 'POST',
							headers: {
								'Content-Type': 'application/json',
								Authorization: `Bearer ${authToken}`,
							},
							body: JSON.stringify(payload),
						}
					);
					if (!response.ok) {
						const errorData = await response
							.json()
							.catch(() => ({}));
						const errorMessage =
							errorData.details ||
							errorData.message ||
							`Erro HTTP ${response.status}`;
						throw new Error(errorMessage);
					}
					logMessage(
						`Categoria "${payload.name}" cadastrada com sucesso!`,
						'success'
					);
					addCategoryForm.reset();
					fetchAllCategories();
				} catch (error) {
					logMessage(
						`Erro ao cadastrar categoria: ${error.message}`,
						'error'
					);
				}
			}

			async function handleUpdateCategory(event) {
				event.preventDefault();
				const id = document.getElementById('edit-category-id').value;
				const payload = {
					group_code: document
						.getElementById('edit-category-code')
						.value.trim(),
					name: document
						.getElementById('edit-category-name')
						.value.trim(),
				};

				logMessage(`Atualizando categoria ID: ${id}...`);
				try {
					const response = await fetch(
						`${apiGroupsUrl}/${id}${sourceQuery}`,
						{
							method: 'PUT',
							headers: {
								'Content-Type': 'application/json',
								Authorization: `Bearer ${authToken}`,
							},
							body: JSON.stringify(payload),
						}
					);
					if (!response.ok) {
						const errorData = await response
							.json()
							.catch(() => ({}));
						const errorMessage =
							errorData.details ||
							errorData.message ||
							`Erro HTTP ${response.status}`;
						throw new Error(errorMessage);
					}
					logMessage(
						`Categoria "${payload.name}" atualizada com sucesso!`,
						'success'
					);
					closeCategoryModal();
					fetchAllCategories();
				} catch (error) {
					logMessage(
						`Erro ao atualizar categoria: ${error.message}`,
						'error'
					);
				}
			}

			async function deleteCategory(id, name) {
				if (
					!(await showConfirm(
						`Tem certeza que deseja excluir a categoria "${name}" (ID: ${id})? Isso pode afetar produtos vinculados.`
					))
				)
					return;
				logMessage(`Excluindo categoria ID: ${id}...`);
				try {
					const response = await fetch(
						`${apiGroupsUrl}/${id}${sourceQuery}`,
						{
							method: 'DELETE',
							headers: { Authorization: `Bearer ${authToken}` },
						}
					);
					if (!response.ok) {
						const errorData = await response
							.json()
							.catch(() => ({}));
						const errorMessage =
							errorData.details ||
							errorData.message ||
							`Erro HTTP ${response.status}`;
						throw new Error(errorMessage);
					}
					logMessage(
						`Categoria "${name}" exclu√≠da com sucesso.`,
						'success'
					);
					fetchAllCategories();
				} catch (error) {
					logMessage(
						`Falha ao excluir categoria: ${error.message}`,
						'error'
					);
				}
			}

			function renderCategoriesList(categories) {
				categoriesListContainer.innerHTML = '';
				if (!categories || categories.length === 0) {
					categoriesListContainer.innerHTML =
						'<div class="text-center p-4">Nenhuma categoria encontrada.</div>';
					return;
				}
				categories.forEach((category) => {
					const categoryDiv = document.createElement('div');
					categoryDiv.className =
						'p-3 bg-white border rounded-lg flex items-center justify-between hover:bg-gray-50';
					categoryDiv.innerHTML = `
						<div>
							<p class="font-bold text-gray-800">${category.name}</p>
							<p class="text-xs text-gray-500">C√≥digo: ${category.group_code} | ID: ${
						category.id
					}</p>
						</div>
						<div class="space-x-2">
							<button onclick='openCategoryModal(${JSON.stringify(
								category
							)})' class="px-3 py-1 bg-yellow-500 text-white text-xs font-semibold rounded hover:bg-yellow-600">Editar</button>
							<button onclick='deleteCategory(${JSON.stringify(
								category.id
							)}, ${JSON.stringify(
						category.name
					)})' class="px-3 py-1 bg-red-600 text-white text-xs font-semibold rounded hover:bg-red-700">Excluir</button>
						</div>
					`;
					categoriesListContainer.appendChild(categoryDiv);
				});
			}

			function openCategoryModal(category) {
				document.getElementById('edit-category-id').value = category.id;
				document.getElementById('edit-category-code').value =
					category.group_code;
				document.getElementById('edit-category-name').value =
					category.name;
				categoryModal.classList.remove('hidden');
			}

			function closeCategoryModal() {
				categoryModal.classList.add('hidden');
			}

			// --- EVENT LISTENERS ---
			startButton.addEventListener('click', handleCadastro);
			startUpdateButton.addEventListener('click', handleUpdateMass);
			fetchProductsButton.addEventListener('click', fetchAllProducts);
			searchButton.addEventListener('click', handleSearch);
			searchInput.addEventListener('keydown', (e) => {
				if (e.key === 'Enter') handleSearch();
			});
			editForm.addEventListener('submit', handleUpdateProduct);
			imageUrlInput.addEventListener('input', (e) => {
				const url = e.target.value.trim();
				imagePreview.src = url || previewPlaceholderUrl;
			});

			// Event Listeners de Categoria
			addCategoryForm.addEventListener('submit', handleAddCategory);
			refreshCategoriesButton.addEventListener(
				'click',
				fetchAllCategories
			);
			editCategoryForm.addEventListener('submit', handleUpdateCategory);
			startCategoriesMassButton.addEventListener('click', handleMassCategories);

			// Carrega categorias ao abrir a aba
			document.addEventListener('DOMContentLoaded', () => {
				// Carregar categorias por padr√£o para popular a lista
				fetchAllCategories();
			});
		</script>
	</body>
</html>